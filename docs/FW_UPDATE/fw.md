---
title: ファームウェア更新
---

この項では本音源のファームウェアを更新する方法を説明します。

## はじめに

本音源は波形生成プロセッサ(Kendryte K210)と周辺制御プロセッサ(RP2040)の二つのマイコンで構成されています。
そのため、本音源のファームウェアを更新するにはそれぞれに適切なファームウェアを書き込む必要があります。

それぞれのページで解説します。

[波形生成プロセッサ](tg.md)

[周辺制御プロセッサ](pp.md)

## 蛇足(なぜ二つのマイコンで構成されているか)

せっかくなので何故マイコンを二つに分けたのかを書いておきます。

開発初期にはDIN5ピンのケーブルで接続するいわゆる「普通のMIDI」を使用しており、マイコンもKendryte K210一つでした。
しかし、小型化をするにあたってDIN5ピンのコネクタは大きすぎたためUSB-MIDIを採用することになりました。TRS-MIDIという3.5mmのイヤホンジャックと同じ端子を用いた規格もありましたが次の理由から採用しませんでした。

- ピン配置がバラバラの場合がある
    - ほぼ統一されたようですがたまに異なるピン配置の機器が存在します
- 電力の供給が別途必要
    - DIN5ピンと流れる信号は全く同じなので電力は別に供給する必要があります
- イヤホンジャックと間違える可能性
    - 同じコネクタが2つあるのはミスのもとになり得ます
- スペース的制約
    - イヤホンジャックは意外と奥行き方向にスペースが必要です

そのため、本音源はUSB-MIDIを使用することにより上のすべての問題を解決しようと試みました。
USB-Cコネクタであれば背も低く、裏表を気にしなくてよいという利便性も得られます。

しかし、問題点として波形生成プロセッサはUARTはあってもUSBペリフェラルは内蔵していませんでした。そのため何らかのICを外付けしてUSB-MIDIに対応させる必要があります。この時候補に挙がったのが次のものです。

- [ATMEGA32U4](https://www.microchip.com/en-us/product/ATmega32U4)
    - Arduino Leonardoなどでお馴染みAVRマイコン
    - 性能のわりに高すぎる(640円)ため見送り
- [RP2040](https://www.raspberrypi.com/documentation/microcontrollers/rp2040.html)
    - 安くて高性能
    - QSPIのFlashが外付けだったりコンデンサがたくさん必要だったりで周辺部品が多め
- [CH345T](https://www.wch-ic.com/products/CH345.html)
    - CH340(USB-シリアル変換IC)などでお馴染みWCH製
    - 多分中身は8051とかのマイコン
    - USB-MIDI Bridgeとかいうほしいものそのまんまな素晴らしい(ように見える)石

最初(Rev.A)ではCH345Tを採用しました。これはUSBを2ポートのMIDIに変換するICで、周辺回路は12MHzの水晶だけです。「なんて便利な石なんだ！」と思って調子に乗り20個ほど注文しましたが実際には使い物になりませんでした。

理由は単純で、「システムエクスクルーシブメッセージに対応していない」からです。
何も流してこないのであればまだ対処のしようがありました。しかし、実際にはメッセージを破壊した状態で送ってくるので手が付けられませんでした。

そのため、次のRev.BからはRP2040をUSB-MIDI変換ブリッジとして使用しています。周辺部品が結構多めで、USBだけ担当させるのは勿体ないと感じたので液晶をつけたりボタンをつけたりSDカードスロットをつけたり(F/W未実装)と機能がゴテゴテと増えていき今に至ります。